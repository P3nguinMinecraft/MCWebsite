{% extends "base.html" %}

{% block title %}Pictures - {{ config.server_name }}{% endblock %}

{% block content %}
<div class="pictures-section">
    <div class="container">
        <div class="pictures-header">
            <h1 class="page-title">Server Gallery</h1>
            
            {% if is_admin %}
            <div class="admin-controls">
                <button class="admin-btn upload-btn" onclick="document.getElementById('fileInput').click()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
                    </svg>
                    Upload Image
                </button>
                <a href="{{ url_for('admin_logout') }}" class="admin-btn logout-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/>
                    </svg>
                    Logout
                </a>
            </div>
            <input type="file" 
                   id="fileInput" 
                   accept="image/png,image/jpeg,image/gif,image/webp" 
                   style="display: none;"
                   onchange="uploadImage(this)">
            {% else %}
            <a href="{{ url_for('admin_login') }}" class="admin-link">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                </svg>
                Admin Login
            </a>
            {% endif %}
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="flash-message flash-{{ category }}">
                    {{ message }}
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        {% if images %}
        <div class="gallery-grid">
            {% for image in images %}
            <div class="gallery-item" data-filename="{{ image.filename }}">
                <img src="{{ url_for('static', filename='pictures/' + image.filename) }}" 
                     alt="{{ image.title }}" 
                     loading="lazy"
                     onclick="openLightbox('{{ url_for('static', filename='pictures/' + image.filename) }}', '{{ image.title }}', '{{ image.description }}')">
                
                <div class="image-info">
                    <div class="image-title-wrapper">
                        <h3 class="image-title" data-original="{{ image.title }}">{{ image.title }}</h3>
                        {% if is_admin %}
                        <button class="icon-btn edit-btn" onclick="editImage(this, '{{ image.filename }}')" title="Edit">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </button>
                        {% endif %}
                    </div>
                    <p class="image-description" data-original="{{ image.description }}">{{ image.description }}</p>
                    
                    {% if is_admin %}
                    <div class="admin-actions" style="display: none;">
                        <button class="icon-btn save-btn" onclick="saveImage(this, '{{ image.filename }}')" title="Save">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </button>
                        <button class="icon-btn cancel-btn" onclick="cancelEdit(this)" title="Cancel">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                        <button class="icon-btn delete-btn" onclick="deleteImage(this, '{{ image.filename }}')" title="Delete">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-gallery">
            <p>No pictures yet!{% if is_admin %} Click "Upload Image" to add some.{% endif %}</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Lightbox Modal -->
<div id="lightbox" class="lightbox" onclick="closeLightbox()">
    <span class="close-lightbox">&times;</span>
    <div class="lightbox-container">
        <img class="lightbox-content" id="lightbox-img">
        <div class="lightbox-info">
            <h2 id="lightbox-title"></h2>
            <p id="lightbox-description"></p>
        </div>
    </div>
</div>

<script>
function openLightbox(src, title, description) {
    const lightbox = document.getElementById('lightbox');
    const img = document.getElementById('lightbox-img');
    const titleEl = document.getElementById('lightbox-title');
    const descEl = document.getElementById('lightbox-description');
    
    img.src = src;
    titleEl.textContent = title;
    descEl.textContent = description;
    
    lightbox.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeLightbox() {
    const lightbox = document.getElementById('lightbox');
    lightbox.style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Close on Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeLightbox();
    }
});

// Admin functions
function editImage(btn, filename) {
    const item = btn.closest('.gallery-item');
    const titleEl = item.querySelector('.image-title');
    const descEl = item.querySelector('.image-description');
    const editBtn = item.querySelector('.edit-btn');
    const adminActions = item.querySelector('.admin-actions');
    
    // Store original values
    titleEl.setAttribute('contenteditable', 'true');
    descEl.setAttribute('contenteditable', 'true');
    titleEl.focus();
    
    // Toggle buttons
    editBtn.style.display = 'none';
    adminActions.style.display = 'flex';
}

function cancelEdit(btn) {
    const item = btn.closest('.gallery-item');
    const titleEl = item.querySelector('.image-title');
    const descEl = item.querySelector('.image-description');
    const editBtn = item.querySelector('.edit-btn');
    const adminActions = item.querySelector('.admin-actions');
    
    // Restore original values
    titleEl.textContent = titleEl.dataset.original;
    descEl.textContent = descEl.dataset.original;
    titleEl.setAttribute('contenteditable', 'false');
    descEl.setAttribute('contenteditable', 'false');
    
    // Toggle buttons
    editBtn.style.display = 'block';
    adminActions.style.display = 'none';
}

async function saveImage(btn, filename) {
    const item = btn.closest('.gallery-item');
    const titleEl = item.querySelector('.image-title');
    const descEl = item.querySelector('.image-description');
    const editBtn = item.querySelector('.edit-btn');
    const adminActions = item.querySelector('.admin-actions');
    
    const title = titleEl.textContent.trim();
    const description = descEl.textContent.trim();
    
    try {
        const response = await fetch('/admin/update-metadata', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ filename, title, description })
        });
        
        if (response.ok) {
            // Update stored values
            titleEl.dataset.original = title;
            descEl.dataset.original = description;
            titleEl.setAttribute('contenteditable', 'false');
            descEl.setAttribute('contenteditable', 'false');
            
            // Toggle buttons
            editBtn.style.display = 'block';
            adminActions.style.display = 'none';
            
            showNotification('Saved successfully!', 'success');
        } else {
            showNotification('Failed to save changes', 'error');
        }
    } catch (error) {
        showNotification('Error: ' + error.message, 'error');
    }
}

async function deleteImage(btn, filename) {
    if (!confirm('Are you sure you want to delete this image?')) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/delete/${filename}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            const item = btn.closest('.gallery-item');
            item.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => {
                item.remove();
                
                // Check if gallery is empty
                const gallery = document.querySelector('.gallery-grid');
                if (gallery && gallery.children.length === 0) {
                    location.reload();
                }
            }, 300);
            
            showNotification('Image deleted successfully', 'success');
        } else {
            showNotification('Failed to delete image', 'error');
        }
    } catch (error) {
        showNotification('Error: ' + error.message, 'error');
    }
}

async function uploadImage(input) {
    if (!input.files || !input.files[0]) return;
    
    const file = input.files[0];
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        showNotification('Uploading...', 'info');
        
        const response = await fetch('/admin/upload', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            showNotification('Upload successful! Refreshing...', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            const data = await response.json();
            showNotification('Upload failed: ' + data.error, 'error');
        }
    } catch (error) {
        showNotification('Error: ' + error.message, 'error');
    }
    
    input.value = '';
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('show');
    }, 10);
    
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}
</script>
{% endblock %}
